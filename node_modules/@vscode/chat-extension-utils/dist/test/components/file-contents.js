"use strict";
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation and GitHub. All rights reserved.
 *--------------------------------------------------------------------------------------------*/
Object.defineProperty(exports, "__esModule", { value: true });
const prompt_tsx_1 = require("@vscode/prompt-tsx");
const chai_1 = require("chai");
const vscode = require("vscode");
const file_context_1 = require("../../components/file-context");
const test_utils_1 = require("./test-utils");
suite('FilesContents', () => {
    let doc;
    suiteSetup(async () => {
        doc = await vscode.workspace.openTextDocument();
        const edit = new vscode.WorkspaceEdit();
        const lines = Array.from({ length: 1000 }, (_, i) => `${i}: lorem ipsum`).join('\n');
        edit.insert(doc.uri, new vscode.Position(0, 0), lines);
        await vscode.workspace.applyEdit(edit);
    });
    const assertIncludesLines = (m, start, end) => {
        const text = (0, test_utils_1.getResultText)(m);
        const lines = [...text.matchAll(/(\d+):/g)];
        (0, chai_1.expect)(`${lines[0][1]}-${lines[lines.length - 1][1]}`).to.equal(`${start}-${end}`);
    };
    const atBudgets = [
        { budget: 200, range: [494, 506] },
        { budget: 400, range: [486, 514] },
        { budget: 10000000, range: [0, 999] },
    ];
    for (const { budget, range } of atBudgets) {
        test(`budget ${budget}`, async () => {
            const p = await (0, test_utils_1.renderTestPrompt)({
                ctor: class extends prompt_tsx_1.PromptElement {
                    render() {
                        return (vscpp(prompt_tsx_1.UserMessage, null,
                            vscpp(file_context_1.FilesContext, { files: [{ value: doc, range: new vscode.Range(490, 0, 510, 0) }] })));
                    }
                },
                props: {},
                budget,
            });
            assertIncludesLines(p, range[0], range[1]);
        });
    }
    test(`does not expand if expansion is turned off`, async () => {
        const p = await (0, test_utils_1.renderTestPrompt)({
            ctor: class extends prompt_tsx_1.PromptElement {
                render() {
                    return (vscpp(prompt_tsx_1.UserMessage, null,
                        vscpp(file_context_1.FilesContext, { files: { value: doc, range: new vscode.Range(490, 0, 510, 0), expand: false } })));
                }
            },
            props: {},
            budget: 100_000,
        });
        assertIncludesLines(p, 490, 510);
    });
    test(`reads a file URI and sets labels`, async () => {
        const p = await (0, test_utils_1.renderTestPrompt)({
            ctor: class extends prompt_tsx_1.PromptElement {
                render() {
                    return (vscpp(prompt_tsx_1.UserMessage, null,
                        vscpp(file_context_1.FilesContext, { files: { value: vscode.Uri.file(__filename), label: 'foo!' } })));
                }
            },
            props: {},
            budget: 100_000,
        });
        (0, chai_1.expect)((0, test_utils_1.getResultText)(p)).to.include('# foo!\n');
        (0, chai_1.expect)((0, test_utils_1.getResultText)(p)).to.include('reads a file URI');
    });
});
